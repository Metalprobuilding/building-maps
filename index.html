<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Delivered Buildings Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 70%;
    }

    #sidebar {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 30%;
      overflow-y: auto;
      background: white;
      padding: 14px;
      border-left: 1px solid #ccc;
      box-sizing: border-box;
    }

    #sidebar h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }
    #sidebar h2 {
      font-size: 16px;
      margin: 0 0 12px;
      color: #333;
    }

    #sidebar h3 {
      font-size: 18px;
      margin-top: 14px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }

    .searchSection input, .searchSection select, .searchSection button,
    .filterSection button {
      padding: 6px 8px;
      margin-right: 6px;
      margin-bottom: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .filterSection button.selected {
      background: #007bff;
      color: white;
    }

    .disclaimer {
      background: #f8f8f8;
      border-left: 4px solid #007bff;
      padding: 8px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .buildingItem {
      margin-bottom: 12px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }

    .footer {
      font-size: 12px;
      color: #555;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 20px;
    }

    .legend {
      margin-top: 12px;
      font-size: 14px;
    }
    .legend img {
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
  <h1>METAL PRO BUILDINGS</h1>
  <h2>Delivered Building Tool – Search or Click on Map</h2>

  <div class="searchSection">
    <input id="cityInput" type="text" placeholder="City" style="width: 120px;" />
    <select id="provSelect" style="width: 100px;">
      <option value="">Province/State</option>
    </select>
    <button id="searchBtn">Search</button>
    <button id="resetBtn">Reset</button>
  </div>

  <div class="filterSection">
    <strong>Filter:</strong><br>
    <button data-filter="Quonset">Quonset</button>
    <button data-filter="Cold_Formed">Cold Formed</button>
    <button data-filter="I_Beam">I-Beam</button>
    <button data-filter="Seacan">Seacan</button>
    <button data-filter="All">Show All</button>
  </div>

  <div class="disclaimer">
    Disclaimer: Delivered buildings is based on site location — we have not validated whether the building is erected.
  </div>

  <h3>Buildings Delivered Here</h3>
  <div id="buildingList"><i>Select a location or search.</i></div>

  <div class="legend" id="legend"></div>

  <div class="footer">
    METAL PRO®<br>
    Engineered by Metal Pro Buildings Inc.<br>
    © METAL PRO® is a registered trademark of Metal Pro Buildings Inc.
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const map = L.map('map').setView([45.9, -82.47], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
 attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const icons = {
 quonset_no_seacan:      L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/quonset_no_seacan.jpg', iconSize:[32,32] }),
 quonset_seacan:         L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/quonset_seacan.jpg', iconSize:[32,32] }),
 cold_formed_no_seacan:  L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/coldformed_no_seacan.jpg', iconSize:[32,32] }),
 cold_formed_seacan:     L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/coldformed_seacan.png', iconSize:[32,32] }),
 i_beam_no_seacan:       L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/ibeam_no_seacan.jpg', iconSize:[32,32] }),
 i_beam_seacan:          L.icon({ iconUrl:'https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/ibeam_seacan.png', iconSize:[32,32] }),
 default:                L.icon({ iconUrl:'https://unpkg.com/leaflet/dist/images/marker-icon.png', iconSize:[32,32] })
};

function pickIcon(type, sea) {
 const t = (type||"").toLowerCase().replace(/[\s\-]+/g,"_");
 const s = (sea||"").trim().toLowerCase()==="yes"?"seacan":"no_seacan";
 return icons[`${t}_${s}`]||icons.default;
}

function updatePanel(city, prov, buildings) {
 const list = document.getElementById('buildingList');
 list.innerHTML = `<i>Buildings in ${city}, ${prov}</i><br><br>`;
 buildings.forEach(b => {
   list.innerHTML += `
     <div class="buildingItem">
       <b>${b.type}</b><br>
       Description: ${b.description||"(no description)"}<br>
       SeaCan: ${b.seaCan||"No"}
     </div>`;
 });
 updateLegend();
}

function updateLegend() {
 const legendDiv = document.getElementById('legend');
 const counts = { quonset:0, cold_formed:0, i_beam:0, seacan:0 };
 allMarkers.forEach(m => {
   if (map.hasLayer(m)) {
     m.data.buildings.forEach(b => {
       const t = b.type.toLowerCase();
       if (t.includes("quonset")) counts.quonset++;
       if (t.includes("cold_formed")) counts.cold_formed++;
       if (t.includes("i_beam")) counts.i_beam++;
       if ((b.seaCan||"").trim().toLowerCase()==="yes") counts.seacan++;
     });
   }
 });
 legendDiv.innerHTML = `
   <b>Legend (visible on map)</b><br>
   <img src="https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/quonset_no_seacan.jpg" width="20"> Quonset: ${counts.quonset}<br>
   <img src="https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/coldformed_no_seacan.jpg" width="20"> Cold Formed: ${counts.cold_formed}<br>
   <img src="https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/icons/ibeam_no_seacan.jpg" width="20"> I-Beam: ${counts.i_beam}<br>
   ⭐ SeaCan (Yes): ${counts.seacan}
 `;
}

// data storage
let allMarkers = [];
let cityToProv = {};
let currentFilter = "All";

// fetch geojson
fetch("https://raw.githubusercontent.com/Metalprobuilding/building-maps/main/buildings.geojson")
.then(res => res.json())
.then(data => {
 data.features.forEach(f => {
   const props = f.properties;
   const cityLower = props.city.toLowerCase();
   const provLower = props.province.toLowerCase();

   // map city→province for dropdown
   cityToProv[cityLower] = cityToProv[cityLower] || new Set();
   cityToProv[cityLower].add(props.province);

   const coords = f.geometry.coordinates;
   const buildings = props.buildings || [];

   // choose marker icon
   let chosen = null;
   for (let b of buildings) {
     if ((b.seaCan||"").trim().toLowerCase()==="yes") { chosen = b; break; }
   }
   if (!chosen && buildings.length>0) chosen = buildings[0];

   const marker = L.marker([coords[1],coords[0]], { icon: pickIcon(chosen?.type, chosen?.seaCan) });
   marker.data = { city: cityLower, prov: provLower, buildings: buildings };

   marker.on('click', () => updatePanel(props.city, props.province, buildings));

   marker.addTo(map);
   allMarkers.push(marker);
 });

})
.catch(err => console.error(err));

// populate province dropdown after city select
document.getElementById('cityInput').addEventListener('change', function() {
 const val = this.value.trim().toLowerCase();
 const select = document.getElementById('provSelect');
 select.innerHTML = '<option value="">Province/State</option>';
 if (cityToProv[val]) {
   [...cityToProv[val]].forEach(p => {
     const opt = document.createElement('option');
     opt.value = p.toLowerCase();
     opt.textContent = p;
     select.appendChild(opt);
   });
 }
});

// filter buttons
document.querySelectorAll('.filterSection button').forEach(btn => {
 btn.addEventListener('click', () => {
   currentFilter = btn.getAttribute('data-filter');
   document.querySelectorAll('.filterSection button').forEach(b=>b.classList.remove('selected'));
   btn.classList.add('selected');
   applyFilters();
   updateLegend();
 });
});

function markerMatches(m) {
 if (currentFilter==="All") return true;
 if (currentFilter==="Seacan") {
   return m.data.buildings.some(b => (b.seaCan||"").trim().toLowerCase()==="yes");
 }
 return m.data.buildings.some(b => b.type===currentFilter);
}

function applyFilters() {
 allMarkers.forEach(m => {
   if (markerMatches(m)) map.addLayer(m);
   else map.removeLayer(m);
 });
}

// search
document.getElementById('searchBtn').addEventListener('click', () => {
 const cityV = document.getElementById('cityInput').value.trim().toLowerCase();
 const provV = document.getElementById('provSelect').value.trim().toLowerCase();
 if (!cityV || !provV) return;

 allMarkers.forEach(m => map.removeLayer(m));
 allMarkers.forEach(m => {
   if (m.data.city===cityV && m.data.prof===provV && markerMatches(m)) {
     map.addLayer(m);
   }
 });
 updateLegend();
});

// reset
document.getElementById('resetBtn').addEventListener('click', () => {
 currentFilter="All";
 document.querySelectorAll('.filterSection button').forEach(b=>b.classList.remove('selected'));
 document.querySelector('.filterSection button[data-filter="All"]').classList.add('selected');
 allMarkers.forEach(m => m.addTo(map));
 updateLegend();
 document.getElementById('buildingList').innerHTML = '<i>Select a location or search.</i>';
});

</script>

</body>
</html>
